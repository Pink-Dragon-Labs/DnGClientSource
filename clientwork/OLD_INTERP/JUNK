00000000: 2f 2f 09 73 63 69 77 2e  63 70 70 0d 0a 2f 2f 20  //.sciw. cpp..// 
00000010: 09 57 69 6e 64 6f 77 73  20 73 74 61 72 74 75 70  .Windows  startup
00000020: 20 72 6f 75 74 69 6e 65  20 66 6f 72 20 74 68 65   routine  for the
00000030: 20 70 73 65 75 64 6f 20  6d 61 63 68 69 6e 65 2e   pseudo  machine.
00000040: 0d 0a 0d 0a 23 69 6e 63  6c 75 64 65 20 22 73 63  ....#inc lude "sc
00000050: 69 77 69 6e 2e 68 70 70  22 0d 0a 23 69 6e 63 6c  iwin.hpp "..#incl
00000060: 75 64 65 20 22 73 6f 6c  2e 68 70 70 22 0d 0a 0d  ude "sol .hpp"...
00000070: 0a 23 69 6e 63 6c 75 64  65 20 22 61 75 64 69 6f  .#includ e "audio
00000080: 2e 68 70 70 22 0d 0a 23  69 6e 63 6c 75 64 65 20  .hpp"..# include 
00000090: 22 63 6f 6e 66 69 67 2e  68 70 70 22 0d 0a 23 69  "config. hpp"..#i
000000a0: 6e 63 6c 75 64 65 20 22  63 72 69 74 65 72 72 77  nclude " criterrw
000000b0: 2e 68 70 70 22 0d 0a 23  69 6e 63 6c 75 64 65 20  .hpp"..# include 
000000c0: 22 65 72 72 6f 72 6d 67  72 2e 68 70 70 22 0d 0a  "errormg r.hpp"..
000000d0: 23 69 6e 63 6c 75 64 65  20 22 65 76 65 6e 74 77  #include  "eventw
000000e0: 2e 68 70 70 22 0d 0a 23  69 6e 63 6c 75 64 65 20  .hpp"..# include 
000000f0: 22 67 72 61 70 68 6d 77  2e 68 70 70 22 0d 0a 23  "graphmw .hpp"..#
00000100: 69 6e 63 6c 75 64 65 20  22 6d 65 6d 6d 67 72 77  include  "memmgrw
00000110: 2e 68 70 70 22 0d 0a 23  69 6e 63 6c 75 64 65 20  .hpp"..# include 
00000120: 22 6d 6f 75 73 65 77 2e  68 70 70 22 0d 0a 23 69  "mousew. hpp"..#i
00000130: 6e 63 6c 75 64 65 20 22  6d 73 67 77 2e 68 70 70  nclude " msgw.hpp
00000140: 22 0d 0a 23 69 6e 63 6c  75 64 65 20 22 73 63 69  "..#incl ude "sci
00000150: 2e 68 70 70 22 0d 0a 23  69 6e 63 6c 75 64 65 20  .hpp"..# include 
00000160: 22 73 6f 75 6e 64 2e 68  70 70 22 0d 0a 23 69 6e  "sound.h pp"..#in
00000170: 63 6c 75 64 65 20 22 74  69 6d 65 77 2e 68 70 70  clude "t imew.hpp
00000180: 22 0d 0a 0d 0a 65 78 74  65 72 6e 20 69 6e 74 20  "....ext ern int 
00000190: 67 41 72 67 63 3b 0d 0a  65 78 74 65 72 6e 20 63  gArgc;.. extern c
000001a0: 68 61 72 20 2a 2a 67 41  72 67 76 3b 0d 0a 0d 0a  har **gA rgv;....
000001b0: 73 74 72 75 63 74 20 53  43 49 57 69 6e 20 3a 20  struct S CIWin : 
000001c0: 53 43 49 20 7b 0d 0a 09  76 6f 69 64 09 09 09 09  SCI {... void....
000001d0: 09 49 6e 69 74 41 75 64  69 6f 28 29 3b 0d 0a 09  .InitAud io();...
000001e0: 76 6f 69 64 09 09 09 09  09 49 6e 69 74 49 6e 74  void.... .InitInt
000001f0: 65 72 72 75 70 74 73 28  29 3b 0d 0a 09 76 6f 69  errupts( );...voi
00000200: 64 09 09 09 09 09 49 6e  69 74 50 61 6c 65 74 74  d.....In itPalett
00000210: 65 28 29 3b 0d 0a 09 76  6f 69 64 09 09 09 09 09  e();...v oid.....
00000220: 49 6e 69 74 53 6f 75 6e  64 28 29 3b 0d 0a 0d 0a  InitSoun d();....
00000230: 09 43 6f 6e 66 69 67 4d  67 72 2a 20 09 20 20 09  .ConfigM gr* .  .
00000240: 20 20 20 4d 61 6b 65 43  6f 6e 66 69 67 4d 67 72     MakeC onfigMgr
00000250: 28 69 6e 74 20 61 72 67  63 2c 20 63 68 61 72 2a  (int arg c, char*
00000260: 20 61 72 67 76 5b 5d 29  3b 0d 0a 09 43 72 69 74   argv[]) ;...Crit
00000270: 45 72 72 48 61 6e 64 6c  65 72 2a 20 09 4d 61 6b  ErrHandl er* .Mak
00000280: 65 43 72 69 74 45 72 72  48 61 6e 64 6c 65 72 28  eCritErr Handler(
00000290: 29 3b 0d 0a 09 45 76 65  6e 74 4d 67 72 2a 09 09  );...Eve ntMgr*..
000002a0: 09 4d 61 6b 65 45 76 65  6e 74 4d 67 72 28 29 3b  .MakeEve ntMgr();
000002b0: 0d 0a 09 47 72 61 70 68  69 63 73 4d 67 72 2a 09  ...Graph icsMgr*.
000002c0: 09 4d 61 6b 65 47 72 61  70 68 69 63 73 4d 67 72  .MakeGra phicsMgr
000002d0: 28 29 3b 0d 0a 09 4d 65  6d 6f 72 79 4d 67 72 2a  ();...Me moryMgr*
000002e0: 09 09 09 4d 61 6b 65 4d  65 6d 6f 72 79 4d 67 72  ...MakeM emoryMgr
000002f0: 28 29 3b 0d 0a 09 53 4f  4c 5f 4d 6f 75 73 65 2a  ();...SO L_Mouse*
00000300: 09 09 09 4d 61 6b 65 4d  6f 75 73 65 28 29 3b 0d  ...MakeM ouse();.
00000310: 0a 09 4d 73 67 4d 67 72  2a 09 09 09 20 09 4d 61  ..MsgMgr *... .Ma
00000320: 6b 65 4d 73 67 4d 67 72  28 29 3b 0d 0a 09 54 69  keMsgMgr ();...Ti
00000330: 6d 65 4d 67 72 2a 09 09  09 20 09 4d 61 6b 65 54  meMgr*.. . .MakeT
00000340: 69 6d 65 4d 67 72 28 29  3b 0d 0a 09 45 72 72 6f  imeMgr() ;...Erro
00000350: 72 4d 67 72 2a 20 20 20  20 20 20 20 09 4d 61 6b  rMgr*        .Mak
00000360: 65 45 72 72 6f 72 4d 67  72 28 29 3b 0d 0a 7d 20  eErrorMg r();..} 
00000370: 73 74 61 74 69 63 20 73  63 69 57 69 6e 3b 0d 0a  static s ciWin;..
00000380: 0d 0a 76 6f 69 64 0d 0a  53 43 49 57 69 6e 3a 3a  ..void.. SCIWin::
00000390: 49 6e 69 74 41 75 64 69  6f 28 29 0d 0a 7b 0d 0a  InitAudi o()..{..
000003a0: 7d 0d 0a 0d 0a 76 6f 69  64 0d 0a 53 43 49 57 69  }....voi d..SCIWi
000003b0: 6e 3a 3a 49 6e 69 74 49  6e 74 65 72 72 75 70 74  n::InitI nterrupt
000003c0: 73 28 29 0d 0a 7b 0d 0a  7d 0d 0a 0d 0a 76 6f 69  s()..{.. }....voi
000003d0: 64 0d 0a 53 43 49 57 69  6e 3a 3a 49 6e 69 74 50  d..SCIWi n::InitP
000003e0: 61 6c 65 74 74 65 28 29  0d 0a 7b 0d 0a 09 2f 2f  alette() ..{...//
000003f0: 20 64 65 66 61 75 6c 74  20 70 61 6c 65 74 74 65   default  palette
00000400: 0d 0a 09 53 4f 4c 50 61  6c 65 74 74 65 2a 20 70  ...SOLPa lette* p
00000410: 61 6c 65 74 74 65 20 3d  20 4e 65 77 20 53 4f 4c  alette =  New SOL
00000420: 50 61 6c 65 74 74 65 3b  0d 0a 09 28 2a 70 61 6c  Palette; ...(*pal
00000430: 65 74 74 65 29 5b 32 35  35 5d 20 3d 20 52 67 62  ette)[25 5] = Rgb
00000440: 32 34 46 28 32 35 35 2c  20 32 35 35 2c 20 32 35  24F(255,  255, 25
00000450: 35 2c 20 31 29 3b 0d 0a  09 61 73 73 65 72 74 28  5, 1);.. .assert(
00000460: 67 72 61 70 68 4d 67 72  29 3b 0d 0a 09 67 72 61  graphMgr );...gra
00000470: 70 68 4d 67 72 2d 3e 47  50 61 6c 65 74 74 65 28  phMgr->G Palette(
00000480: 29 2e 53 75 62 6d 69 74  28 2a 70 61 6c 65 74 74  ).Submit (*palett
00000490: 65 29 3b 0d 0a 09 67 72  61 70 68 4d 67 72 2d 3e  e);...gr aphMgr->
000004a0: 47 50 61 6c 65 74 74 65  28 29 2e 55 70 64 61 74  GPalette ().Updat
000004b0: 65 46 6f 72 46 72 61 6d  65 28 29 3b 0d 0a 09 67  eForFram e();...g
000004c0: 72 61 70 68 4d 67 72 2d  3e 47 50 61 6c 65 74 74  raphMgr- >GPalett
000004d0: 65 28 29 2e 55 70 64 61  74 65 48 61 72 64 77 61  e().Upda teHardwa
000004e0: 72 65 28 29 3b 0d 0a 09  64 65 6c 65 74 65 20 70  re();... delete p
000004f0: 61 6c 65 74 74 65 3b 0d  0a 7d 0d 0a 0d 0a 76 6f  alette;. .}....vo
00000500: 69 64 0d 0a 53 43 49 57  69 6e 3a 3a 49 6e 69 74  id..SCIW in::Init
00000510: 53 6f 75 6e 64 28 29 0d  0a 7b 0d 0a 7d 0d 0a 0d  Sound(). .{..}...
00000520: 0a 43 6f 6e 66 69 67 4d  67 72 2a 0d 0a 53 43 49  .ConfigM gr*..SCI
00000530: 57 69 6e 3a 3a 4d 61 6b  65 43 6f 6e 66 69 67 4d  Win::Mak eConfigM
00000540: 67 72 28 69 6e 74 20 61  72 67 63 2c 20 63 68 61  gr(int a rgc, cha
00000550: 72 2a 20 61 72 67 76 5b  5d 29 0d 0a 7b 0d 0a 09  r* argv[ ])..{...
00000560: 43 6f 6e 66 69 67 4d 67  72 2a 20 63 6f 6e 66 69  ConfigMg r* confi
00000570: 67 4d 20 3d 20 4e 65 77  20 43 6f 6e 66 69 67 4d  gM = New  ConfigM
00000580: 67 72 28 22 72 65 73 6f  75 72 63 65 2e 77 69 6e  gr("reso urce.win
00000590: 22 2c 20 61 72 67 63 2c  20 61 72 67 76 29 3b 0d  ", argc,  argv);.
000005a0: 0a 0d 0a 09 2f 2f 20 61  64 64 20 74 68 65 20 57  ....// a dd the W
000005b0: 69 6e 64 6f 77 73 20 70  61 74 63 68 20 64 69 72  indows p atch dir
000005c0: 65 63 74 6f 72 79 20 73  6f 20 69 74 20 77 69 6c  ectory s o it wil
000005d0: 6c 20 62 65 20 73 65 61  72 63 68 65 64 20 66 69  l be sea rched fi
000005e0: 72 73 74 0d 0a 09 63 6f  6e 66 69 67 4d 2d 3e 41  rst...co nfigM->A
000005f0: 64 64 54 6f 6b 65 6e 54  6f 46 72 6f 6e 74 28 22  ddTokenT oFront("
00000600: 70 61 74 63 68 44 69 72  22 2c 73 7a 57 69 6e 50  patchDir ",szWinP
00000610: 61 74 63 68 44 69 72 29  3b 0d 0a 09 72 65 74 75  atchDir) ;...retu
00000620: 72 6e 20 63 6f 6e 66 69  67 4d 3b 0d 0a 7d 20 20  rn confi gM;..}  
00000630: 0d 0a 0d 0a 43 72 69 74  45 72 72 48 61 6e 64 6c  ....Crit ErrHandl
00000640: 65 72 2a 0d 0a 53 43 49  57 69 6e 3a 3a 4d 61 6b  er*..SCI Win::Mak
00000650: 65 43 72 69 74 45 72 72  48 61 6e 64 6c 65 72 28  eCritErr Handler(
00000660: 29 0d 0a 7b 0d 0a 09 72  65 74 75 72 6e 20 4e 65  )..{...r eturn Ne
00000670: 77 20 43 72 69 74 45 72  72 48 61 6e 64 6c 65 72  w CritEr rHandler
00000680: 57 69 6e 3b 0d 0a 7d 0d  0a 0d 0a 45 76 65 6e 74  Win;..}. ...Event
00000690: 4d 67 72 2a 0d 0a 53 43  49 57 69 6e 3a 3a 4d 61  Mgr*..SC IWin::Ma
000006a0: 6b 65 45 76 65 6e 74 4d  67 72 28 29 0d 0a 7b 0d  keEventM gr()..{.
000006b0: 0a 09 72 65 74 75 72 6e  20 4e 65 77 20 45 76 65  ..return  New Eve
000006c0: 6e 74 4d 67 72 57 69 6e  3b 0d 0a 7d 0d 0a 0d 0a  ntMgrWin ;..}....
000006d0: 47 72 61 70 68 69 63 73  4d 67 72 2a 0d 0a 53 43  Graphics Mgr*..SC
000006e0: 49 57 69 6e 3a 3a 4d 61  6b 65 47 72 61 70 68 69  IWin::Ma keGraphi
000006f0: 63 73 4d 67 72 28 29 0d  0a 7b 0d 0a 09 47 72 61  csMgr(). .{...Gra
00000700: 70 68 69 63 73 4d 67 72  2a 20 67 4d 67 72 20 3d  phicsMgr * gMgr =
00000710: 20 4e 65 77 20 47 72 61  70 68 69 63 73 4d 67 72   New Gra phicsMgr
00000720: 57 69 6e 28 67 61 6d 65  57 69 64 74 68 2c 20 67  Win(game Width, g
00000730: 61 6d 65 48 65 69 67 68  74 29 3b 0d 0a 09 69 66  ameHeigh t);...if
00000740: 20 28 44 4f 50 50 43 54  45 53 54 29 0d 0a 09 09   (DOPPCT EST)....
00000750: 28 28 47 72 61 70 68 69  63 73 4d 67 72 57 69 6e  ((Graphi csMgrWin
00000760: 2a 29 67 4d 67 72 29 2d  3e 54 69 6d 69 6e 67 54  *)gMgr)- >TimingT
00000770: 65 73 74 28 29 3b 0d 0a  09 72 65 74 75 72 6e 20  est();.. .return 
00000780: 67 4d 67 72 3b 0d 0a 7d  0d 0a 0d 0a 4d 65 6d 6f  gMgr;..} ....Memo
00000790: 72 79 4d 67 72 2a 0d 0a  53 43 49 57 69 6e 3a 3a  ryMgr*.. SCIWin::
000007a0: 4d 61 6b 65 4d 65 6d 6f  72 79 4d 67 72 28 29 0d  MakeMemo ryMgr().
000007b0: 0a 7b 0d 0a 09 72 65 74  75 72 6e 20 4e 65 77 20  .{...ret urn New 
000007c0: 4d 65 6d 6f 72 79 4d 67  72 57 69 6e 3b 0d 0a 7d  MemoryMg rWin;..}
000007d0: 0d 0a 0d 0a 53 4f 4c 5f  4d 6f 75 73 65 2a 0d 0a  ....SOL_ Mouse*..
000007e0: 53 43 49 57 69 6e 3a 3a  4d 61 6b 65 4d 6f 75 73  SCIWin:: MakeMous
000007f0: 65 28 29 0d 0a 7b 0d 0a  53 4f 4c 5f 4d 6f 75 73  e()..{.. SOL_Mous
00000800: 65 2a 20 6d 6f 75 73 65  3b 0d 0a 0d 0a 09 63 6c  e* mouse ;.....cl
00000810: 72 4d 6f 75 73 65 20 3d  20 4e 65 77 20 4d 6f 75  rMouse =  New Mou
00000820: 73 65 57 69 6e 43 6c 72  28 29 3b 0d 0a 09 77 69  seWinClr ();...wi
00000830: 6e 4d 6f 75 73 65 20 3d  20 4e 65 77 20 4d 6f 75  nMouse =  New Mou
00000840: 73 65 57 69 6e 28 29 3b  0d 0a 09 6d 6f 75 73 65  seWin(); ...mouse
00000850: 20 3d 20 63 6c 72 4d 6f  75 73 65 3b 0d 0a 09 61   = clrMo use;...a
00000860: 73 73 65 72 74 28 67 72  61 70 68 4d 67 72 29 3b  ssert(gr aphMgr);
00000870: 0d 0a 09 67 72 61 70 68  4d 67 72 2d 3e 47 43 75  ...graph Mgr->GCu
00000880: 72 73 6f 72 28 29 2e 53  65 74 44 65 76 69 63 65  rsor().S etDevice
00000890: 28 2a 6d 6f 75 73 65 29  3b 0d 0a 0d 0a 09 69 66  (*mouse) ;.....if
000008a0: 20 28 21 43 4f 4c 4f 52  43 55 52 53 4f 52 29 0d   (!COLOR CURSOR).
000008b0: 0a 09 09 6d 6f 75 73 65  20 3d 20 77 69 6e 4d 6f  ...mouse  = winMo
000008c0: 75 73 65 3b 0d 0a 09 72  65 74 75 72 6e 20 6d 6f  use;...r eturn mo
000008d0: 75 73 65 3b 0d 0a 7d 0d  0a 0d 0a 4d 73 67 4d 67  use;..}. ...MsgMg
000008e0: 72 2a 0d 0a 53 43 49 57  69 6e 3a 3a 4d 61 6b 65  r*..SCIW in::Make
000008f0: 4d 73 67 4d 67 72 28 29  0d 0a 7b 0d 0a 09 72 65  MsgMgr() ..{...re
00000900: 74 75 72 6e 20 4e 65 77  20 4d 73 67 4d 67 72 57  turn New  MsgMgrW
00000910: 69 6e 3b 0d 0a 7d 0d 0a  0d 0a 54 69 6d 65 4d 67  in;..}.. ..TimeMg
00000920: 72 2a 0d 0a 53 43 49 57  69 6e 3a 3a 4d 61 6b 65  r*..SCIW in::Make
00000930: 54 69 6d 65 4d 67 72 28  29 0d 0a 7b 0d 0a 09 72  TimeMgr( )..{...r
00000940: 65 74 75 72 6e 20 4e 65  77 20 54 69 6d 65 4d 67  eturn Ne w TimeMg
00000950: 72 57 69 6e 3b 0d 0a 7d  0d 0a 0d 0a 0d 0a 2f 2f  rWin;..} ......//
00000960: 20 54 68 65 20 66 6f 6e  74 20 6d 61 6e 61 67 65   The fon t manage
00000970: 72 0d 0a 45 72 72 6f 72  4d 67 72 2a 20 20 20 65  r..Error Mgr*   e
00000980: 72 72 6f 72 4d 67 72 3b  0d 0a 0d 0a 45 72 72 6f  rrorMgr; ....Erro
00000990: 72 4d 67 72 2a 0d 0a 53  43 49 57 69 6e 3a 3a 4d  rMgr*..S CIWin::M
000009a0: 61 6b 65 45 72 72 6f 72  4d 67 72 28 29 0d 0a 7b  akeError Mgr()..{
000009b0: 0d 0a 2f 2f 09 72 65 74  75 72 6e 20 4e 65 77 20  ..//.ret urn New 
000009c0: 45 72 72 6f 72 4d 67 72  28 29 3b 0d 0a 09 72 65  ErrorMgr ();...re
000009d0: 74 75 72 6e 20 30 3b 0d  0a 7d 0d 0a 0d 0a 2f 2f  turn 0;. .}....//
000009e0: 2f 2f 2f 2f 2f 2f 2f 2f  2f 2f 2f 2f 2f 2f 2f 2f  //////// ////////
000009f0: 2f 2f 2f 2f 2f 2f 2f 2f  2f 2f 2f 2f 2f 2f 2f 2f  //////// ////////
00000a00: 2f 2f 2f 2f 2f 2f 2f 2f  2f 2f 2f 2f 2f 2f 2f 2f  //////// ////////
00000a10: 2f 2f 2f 2f 2f 2f 2f 2f  2f 2f 2f 2f 2f 2f 2f 2f  //////// ////////
00000a20: 2f 2f 2f 2f 2f 2f 2f 2f  2f 2f 2f 2f 0d 0a 0d 0a  //////// ////....
00000a30: 69 6e 74 0d 0a 73 63 69  6d 61 69 6e 28 69 6e 74  int..sci main(int
00000a40: 20 61 72 67 63 2c 20 63  68 61 72 2a 20 61 72 67   argc, c har* arg
00000a50: 76 5b 5d 29 0d 0a 7b 0d  0a 09 2f 2f 20 42 55 47  v[])..{. ..// BUG
00000a60: 42 55 47 20 2d 20 4a 4c  20 2d 20 38 2f 37 2f 39  BUG - JL  - 8/7/9
00000a70: 35 20 2d 20 54 68 65 20  66 6f 6c 6c 6f 77 69 6e  5 - The  followin
00000a80: 67 20 63 6f 64 65 20 69  73 20 61 20 74 65 6d 70  g code i s a temp
00000a90: 20 66 69 78 20 66 6f 72  20 50 68 61 6e 74 61 73   fix for  Phantas
00000aa0: 0d 0a 09 2f 2f 20 54 75  72 6e 73 20 74 68 65 20  ...// Tu rns the 
00000ab0: 76 6d 64 53 6b 69 70 4f  6e 20 74 6f 20 46 61 6c  vmdSkipO n to Fal
00000ac0: 73 65 20 66 6f 72 20 57  69 6e 39 35 2e 20 20 43  se for W in95.  C
00000ad0: 61 6e 20 62 65 20 6f 76  65 72 72 69 64 65 6e 20  an be ov erriden 
00000ae0: 76 69 61 20 0d 0a 20 20  20 2f 2f 20 72 65 73 6f  via ..    // reso
00000af0: 75 72 63 65 2e 77 69 6e  0d 0a 0d 0a 2f 2f 09 61  urce.win ....//.a
00000b00: 73 73 65 72 74 28 4c 4f  42 59 54 45 28 4c 4f 57  ssert(LO BYTE(LOW
00000b10: 4f 52 44 28 47 65 74 56  65 72 73 69 6f 6e 28 29  ORD(GetV ersion()
00000b20: 29 29 20 3d 3d 20 33 29  3b 20 20 09 2f 2f 20 76  )) == 3) ;  .// v
00000b30: 65 72 73 69 6f 6e 20 33  20 71 75 69 72 6b 20 77  ersion 3  quirk w
00000b40: 69 74 68 0d 0a 09 09 0d  0a 09 73 63 69 20 3d 20  ith..... ..sci = 
00000b50: 26 73 63 69 57 69 6e 3b  0d 0a 0d 0a 09 73 63 69  &sciWin; .....sci
00000b60: 2d 3e 52 75 6e 28 61 72  67 63 2c 20 61 72 67 76  ->Run(ar gc, argv
00000b70: 29 3b 0d 0a 0d 0a 09 72  65 74 75 72 6e 20 30 3b  );.....r eturn 0;
00000b80: 0d 0a 7d 0d 0a 1a 0d 0a                           ..}.....
